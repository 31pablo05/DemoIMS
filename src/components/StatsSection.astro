---
const stats = [
  {
    numero: '30+',
    texto: 'Años de Experiencia',
    descripcion: 'Liderando la medicina regional',
    icon: `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="8" y="14" width="32" height="28" rx="3" stroke="currentColor" stroke-width="2"/>
      <path d="M16 14V10a8 8 0 0116 0v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M24 24v8M20 28h8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
    </svg>`
  },
  {
    numero: '10+',
    texto: 'Profesionales',
    descripcion: 'Especialistas de alto nivel',
    icon: `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="18" cy="16" r="7" stroke="currentColor" stroke-width="2"/>
      <circle cx="34" cy="19" r="5" stroke="currentColor" stroke-width="2"/>
      <path d="M4 38c0-7.18 6.268-13 14-13s14 5.82 14 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M34 32c3.866 0 7 2.686 7 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`
  },
  {
    numero: '24/7',
    texto: 'Guardia Médica',
    descripcion: 'Atención sin interrupciones',
    icon: `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="24" cy="24" r="17" stroke="currentColor" stroke-width="2"/>
      <path d="M24 12v13l7 5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="24" cy="24" r="2" fill="currentColor"/>
    </svg>`
  },
  {
    numero: '15k+',
    texto: 'Pacientes Atendidos',
    descripcion: 'Vidas transformadas con cuidado',
    icon: `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M24 38s-16-9.5-16-21a10 10 0 0120 0 10 10 0 0120 0c0 11.5-24 21-24 21z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`
  }
];
---

<section class="stats-section" aria-labelledby="stats-heading">
  <!-- Canvas for animated particles -->
  <canvas id="stats-canvas" class="stats-canvas" aria-hidden="true"></canvas>

  <!-- Background geometry -->
  <div class="bg-geo" aria-hidden="true">
    <div class="geo-circle geo-1"></div>
    <div class="geo-circle geo-2"></div>
    <div class="geo-line geo-line-h"></div>
    <div class="geo-line geo-line-v"></div>
  </div>

  <div class="stats-inner">
    <!-- Header -->
    <header class="stats-header" data-animate>
      <div class="stats-eyebrow">
        <span class="eyebrow-dot"></span>
        Instituto Médico en Cifras
        <span class="eyebrow-dot"></span>
      </div>
      <h2 id="stats-heading" class="stats-title">
        La confianza se construye<br/>con <em>resultados reales</em>
      </h2>
    </header>

    <!-- Grid -->
    <div class="stats-grid">
      {stats.map((stat, i) => (
        <article
          class="stat-card"
          data-index={i}
          data-animate
          style={`--delay: ${i * 120}ms`}
        >
          <!-- Top accent line (animates in) -->
          <div class="card-top-line"></div>

          <!-- Icon -->
          <div class="card-icon" set:html={stat.icon} />

          <!-- Number -->
          <div class="card-number" data-target={stat.numero}>
            <span class="number-value">{stat.numero}</span>
          </div>

          <!-- Divider -->
          <div class="card-divider"></div>

          <!-- Text -->
          <div class="card-label">{stat.texto}</div>
          <div class="card-desc">{stat.descripcion}</div>

          <!-- Hover glow -->
          <div class="card-glow" aria-hidden="true"></div>
        </article>
      ))}
    </div>
  </div>
</section>

<style>
  /* ── ROOT ── */
  .stats-section {
    position: relative;
    padding: 110px 5% 130px;
    overflow: hidden;
    background: #001e36;
    font-family: 'Inter', system-ui, sans-serif;
  }

  /* ── CANVAS ── */
  .stats-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    opacity: 0.35;
  }

  /* ── BACKGROUND GEOMETRY ── */
  .bg-geo { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }

  .geo-circle {
    position: absolute;
    border-radius: 50%;
    border: 1px solid rgba(0,168,225,0.10);
  }
  .geo-1 {
    width: 700px; height: 700px;
    top: -200px; left: -200px;
  }
  .geo-2 {
    width: 500px; height: 500px;
    bottom: -150px; right: -100px;
    border-color: rgba(0,168,225,0.06);
  }

  .geo-line {
    position: absolute;
    background: rgba(0,168,225,0.06);
  }
  .geo-line-h {
    left: 0; right: 0;
    top: 50%; height: 1px;
    transform: translateY(-50%);
  }
  .geo-line-v {
    top: 0; bottom: 0;
    left: 50%; width: 1px;
  }

  /* ── INNER ── */
  .stats-inner {
    position: relative;
    z-index: 10;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ── HEADER ── */
  .stats-header {
    text-align: center;
    margin-bottom: 72px;
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }
  .stats-header.visible { opacity: 1; transform: translateY(0); }

  .stats-eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: #60c2f5;
    margin-bottom: 20px;
    font-family: 'Inter', system-ui, sans-serif;
  }
  .eyebrow-dot {
    width: 4px; height: 4px;
    border-radius: 50%;
    background: #60c2f5;
    display: inline-block;
  }

  .stats-title {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: clamp(1.9rem, 3.8vw, 3rem);
    font-weight: 700;
    color: #fff;
    line-height: 1.15;
    letter-spacing: -0.03em;
    margin: 0;
  }
  .stats-title em {
    font-style: normal;
    font-weight: 800;
    background: linear-gradient(135deg, #60c2f5 0%, #a8e6ff 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* ── GRID ── */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px;
    overflow: hidden;
  }

  /* ── CARD ── */
  .stat-card {
    position: relative;
    padding: 52px 36px 48px;
    background: rgba(0,18,40,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow: hidden;
    opacity: 0;
    transform: translateY(30px);
    transition:
      opacity 0.7s ease var(--delay, 0ms),
      transform 0.7s ease var(--delay, 0ms),
      background 0.3s ease;
    cursor: default;
  }
  .stat-card.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .stat-card:hover {
    background: rgba(0,30,60,0.92);
    z-index: 2;
  }

  /* top accent line */
  .card-top-line {
    position: absolute;
    top: 0; left: 50%; right: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #0074B7, #00A8E1, transparent);
    transition: left 0.4s ease, right 0.4s ease;
  }
  .stat-card:hover .card-top-line {
    left: 0; right: 0;
  }

  /* hover glow */
  .card-glow {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,116,183,0.12) 0%, transparent 65%);
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
  }
  .stat-card:hover .card-glow { opacity: 1; }

  /* icon */
  .card-icon {
    width: 52px; height: 52px;
    color: #60c2f5;
    margin-bottom: 28px;
    opacity: 0.85;
    transition: opacity 0.3s, transform 0.3s;
  }
  .card-icon svg { width: 100%; height: 100%; }
  .stat-card:hover .card-icon {
    opacity: 1;
    transform: translateY(-3px);
  }

  /* number */
  .card-number {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: clamp(2.8rem, 4.2vw, 4rem);
    font-weight: 800;
    color: #fff;
    line-height: 1;
    margin-bottom: 18px;
    letter-spacing: -0.04em;
  }
  .number-value { display: inline-block; }

  /* divider */
  .card-divider {
    width: 32px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(96,194,245,0.5), transparent);
    margin-bottom: 16px;
    transition: width 0.4s ease;
  }
  .stat-card:hover .card-divider { width: 56px; }

  /* text */
  .card-label {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.92rem;
    font-weight: 600;
    color: rgba(255,255,255,0.92);
    letter-spacing: 0.01em;
    margin-bottom: 8px;
  }
  .card-desc {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.77rem;
    font-weight: 400;
    color: rgba(255,255,255,0.38);
    letter-spacing: 0.02em;
    line-height: 1.6;
  }

  /* ── RESPONSIVE ── */
  @media (max-width: 900px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 520px) {
    .stats-section { padding: 80px 5% 90px; }
    .stats-header { margin-bottom: 48px; }
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 1px; }
    .stat-card { padding: 36px 20px; }
    .card-number { font-size: 2.6rem; }
  }
</style>

<script>
  // ── Intersection Observer: animate on scroll ──
  const animatables = document.querySelectorAll('[data-animate]');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.15 });
  animatables.forEach(el => observer.observe(el));

  // ── Counter animation ──
  const parseNum = (str: string) => parseFloat(str.replace(/[^0-9.]/g, ''));
  const formatNum = (n: number, original: string) => {
    const hasK = original.includes('k');
    const hasPlus = original.includes('+');
    const hasSlash = original.includes('/');
    if (hasSlash) return original; // 24/7 — don't animate
    let out = hasK ? (n >= 1000 ? `${(n/1000).toFixed(0)}k` : `${n}`) : `${Math.round(n)}`;
    if (hasPlus) out += '+';
    return out;
  };

  const counters = document.querySelectorAll('.card-number');
  const counterObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const el = entry.target as HTMLElement;
      const original = el.dataset.target || '';
      const target = parseNum(original);
      if (isNaN(target) || original.includes('/')) return; // skip 24/7
      
      const span = el.querySelector('.number-value') as HTMLElement;
      if (!span) return;

      const duration = 1800;
      const start = performance.now();
      const ease = (t: number) => 1 - Math.pow(1 - t, 3);

      const tick = (now: number) => {
        const t = Math.min((now - start) / duration, 1);
        span.textContent = formatNum(target * ease(t), original);
        if (t < 1) requestAnimationFrame(tick);
        else span.textContent = original;
      };
      requestAnimationFrame(tick);
      counterObserver.unobserve(el);
    });
  }, { threshold: 0.5 });
  counters.forEach(el => counterObserver.observe(el));

  // ── Particle canvas ──
  const canvas = document.getElementById('stats-canvas') as HTMLCanvasElement;
  if (canvas) {
    const ctx = canvas.getContext('2d')!;
    let W = canvas.width  = canvas.offsetWidth;
    let H = canvas.height = canvas.offsetHeight;

    window.addEventListener('resize', () => {
      W = canvas.width  = canvas.offsetWidth;
      H = canvas.height = canvas.offsetHeight;
    });

    const N = 55;
    const dots = Array.from({ length: N }, () => ({
      x: Math.random() * W, y: Math.random() * H,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.3,
      r: Math.random() * 1.5 + 0.4,
    }));

    const LINK = 130;

    const draw = () => {
      ctx.clearRect(0, 0, W, H);
      dots.forEach(d => {
        d.x += d.vx; d.y += d.vy;
        if (d.x < 0) d.x = W; if (d.x > W) d.x = 0;
        if (d.y < 0) d.y = H; if (d.y > H) d.y = 0;

        ctx.beginPath();
        ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,168,225,0.55)';
        ctx.fill();
      });

      for (let i = 0; i < dots.length; i++) {
        for (let j = i + 1; j < dots.length; j++) {
          const dx = dots[i].x - dots[j].x;
          const dy = dots[i].y - dots[j].y;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < LINK) {
            ctx.beginPath();
            ctx.moveTo(dots[i].x, dots[i].y);
            ctx.lineTo(dots[j].x, dots[j].y);
            ctx.strokeStyle = `rgba(0,168,225,${0.14 * (1 - dist/LINK)})`;
            ctx.lineWidth = 0.6;
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(draw);
    };
    draw();
  }
</script>